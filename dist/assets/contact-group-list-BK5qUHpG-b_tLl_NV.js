import{v as t,d as je,m as fe,h as Ne,p as ve,x as e,Z as l,j as G,z as T,P as z,I as q,R as K,Y as be}from"./index-DnKD0KXe.js";import{o as _}from"./skeleton-mX7TdaWE-Cq_BwO7K.js";import{x as re,w as le,n as ye,m as we,p as O,f as W,b as j,i as Ce}from"./table-DQfnjL0Y-DmfacWdK.js";import{a as ke}from"./useMeta-Do0ZXGYI-DbPzVoKD.js";import{o as ie}from"./search-B37cGDDG-qSBiOTEd.js";import{y as ze,r as _e,d as Se}from"./layout-list-ObnFiE7M-Cwvb1Wq-.js";function de({node:i,depth:f,idToName:S,onView:c,onEdit:N,onDelete:P}){const[u,o]=t.useState(!0),v=i.children.length>0,b=i.parent_group?S.get(i.parent_group)||String(i.parent_group):null;return e.jsxs("li",{className:"text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between py-2",style:{paddingLeft:f*12},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[v?e.jsx("button",{type:"button","aria-label":u?"Collapse":"Expand",className:"text-muted-foreground hover:text-foreground transition-colors",onClick:()=>o(p=>!p),children:u?e.jsx(Se,{className:"size-4"}):e.jsx(be,{className:"size-4"})}):e.jsx("span",{className:"inline-block w-4"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium flex items-center gap-2",children:[e.jsx("span",{children:i.name}),v?e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",i.children.length,")"]}):null]}),b&&e.jsxs("div",{className:"text-muted-foreground",children:["Parent: ",b]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{size:"sm",variant:"outline",onClick:()=>c(i.id),children:"View"}),e.jsx(l,{size:"sm",variant:"outline",onClick:()=>N(i.id,i.name,i.parent_group),children:"Edit"}),e.jsx(l,{size:"sm",variant:"destructive",onClick:()=>P(i.id),children:"Delete"})]})]}),v&&u&&e.jsx("ul",{className:"ml-2 border-l pl-3",children:i.children.map(p=>e.jsx(de,{node:p,depth:f+1,idToName:S,onView:c,onEdit:N,onDelete:P},p.id))})]})}const $e=()=>{const[i,f]=t.useState("name"),{title:S}=ke("/contact/groups","Contact Groups • PayFirst"),[c,N]=t.useState(""),[P,u]=t.useState({}),{data:o,isLoading:v,isFetching:b}=je({ordering:i,search:P.name||void 0}),[p,{isLoading:ce}]=fe(),[oe,{isLoading:me}]=Ne(),[ue,{isLoading:B}]=ve(),[L,J]=t.useState(""),[V,Q]=t.useState(""),[X,D]=t.useState(null),[xe,y]=t.useState(!1),[w,x]=t.useState(1),[A,pe]=t.useState(10),[h,H]=t.useState(!0),[U,E]=t.useState(null),[R,g]=t.useState(null),[ee,I]=t.useState(""),[Y,Z]=t.useState(""),[M,C]=t.useState(null),se=o&&!o.status?String(o.error??"Server error"):null,d=t.useMemo(()=>{if(o&&typeof o!="string"){const s=o;if(s.status)return s.data}return[]},[o]),F=t.useMemo(()=>d.some(s=>Array.isArray(s.subgroups)&&s.subgroups.length>0),[d]),he=s=>{const a=[],r=(n,$)=>{a.push({id:n.id,name:n.name,owner:n.owner,parent_group:$}),Array.isArray(n.subgroups)&&n.subgroups.forEach(k=>r(k,n.id))};return s.forEach(n=>r(n,n.parent_group??null)),a},m=t.useMemo(()=>F?he(d):d,[d,F]),ae=t.useMemo(()=>{const s=new Map;return m.forEach(a=>s.set(a.id,a.name)),s},[m]),ne=t.useMemo(()=>{if(F){const r=n=>({id:n.id,name:n.name,parent_group:n.parent_group??null,children:Array.isArray(n.subgroups)?n.subgroups.map(r):[]});return d.map(r)}const s=new Map,a=[];for(const r of d)s.set(r.id,{id:r.id,name:r.name,parent_group:r.parent_group??null,children:[]});for(const r of d){const n=s.get(r.id);r.parent_group&&s.has(r.parent_group)?s.get(r.parent_group).children.push(n):a.push(n)}return a},[d,F]),ge=async s=>{if(s.preventDefault(),D(null),!L.trim())return D("Name is required"),!1;try{const a=await p({name:L.trim(),parent_group:V===""?null:V}).unwrap();return J(""),Q(""),z.success(q(a,"Group created")),!0}catch(a){return D(K(a)),!1}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h1",{className:"text-xl font-semibold",children:S.replace(/\s*•\s*PayFirst$/,"")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Organize your contacts into groups and subgroups."})]}),se&&e.jsx("div",{className:"max-w-xl rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:se}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{}),e.jsx(l,{size:"sm",onClick:()=>{y(!0),D(null)},children:"New Group"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"font-medium",children:"All groups"}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsxs("div",{className:"relative",children:[e.jsx(G,{value:c,onChange:s=>{N(s.target.value)},onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),u({name:c.trim()||void 0}),x(1))},placeholder:"Filter name…",className:"pl-8 pr-20 h-9 w-56"}),e.jsx(ie,{className:"absolute left-2 top-2.5 size-4 text-muted-foreground"}),e.jsxs("div",{className:"absolute inset-y-0 right-0 flex items-center pr-1",children:[e.jsx("span",{className:"h-5 w-px bg-border mr-1","aria-hidden":"true"}),e.jsx(l,{type:"button",variant:"ghost","aria-label":"Apply",title:"Apply",className:"h-9 px-2",disabled:b,onClick:()=>{u({name:c.trim()||void 0}),x(1)},children:"Apply"})]})]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>f(s=>s==="name"?"-name":"name"),className:"gap-1",children:[i.includes("name")&&i.startsWith("-")?e.jsx(re,{className:"size-4"}):e.jsx(le,{className:"size-4"})," Sort"]}),!h&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-muted-foreground",htmlFor:"group-page-size",children:"Rows per page"}),e.jsxs("select",{id:"group-page-size",className:"h-8 rounded-md border bg-background px-2 text-sm",value:A,onChange:s=>{pe(Number(s.target.value)),x(1)},children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:25,children:"25"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]})]}),e.jsxs(l,{variant:h?"default":"outline",size:"sm",className:"gap-1",onClick:()=>H(!0),children:[e.jsx(ze,{className:"size-4"})," Tree"]}),e.jsxs(l,{variant:h?"outline":"default",size:"sm",className:"gap-1",onClick:()=>H(!1),children:[e.jsx(_e,{className:"size-4"})," List"]})]})]}),v?e.jsx("div",{className:"grid gap-2",children:Array.from({length:5}).map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border p-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_,{className:"h-4 w-40"}),e.jsx(_,{className:"h-4 w-24"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-8 w-16"}),e.jsx(_,{className:"h-8 w-16"}),e.jsx(_,{className:"h-8 w-16"})]})]},a))}):m.length?h?e.jsx("ul",{className:"rounded-md border p-2",children:ne.map(s=>e.jsx(de,{node:s,depth:0,idToName:ae,onView:a=>E(a),onEdit:(a,r,n)=>{g(a),I(r),Z(n??"")},onDelete:a=>C(a)},s.id))}):e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsxs(ye,{children:[e.jsxs(we,{children:[e.jsxs(O,{children:[e.jsx(W,{className:"cursor-pointer select-none",onClick:()=>f(s=>s==="name"?"-name":"name"),children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:["Name ",i.includes("name")&&(i.startsWith("-")?e.jsx(re,{className:"size-4"}):e.jsx(le,{className:"size-4"}))]})}),e.jsx(W,{children:"Parent"}),e.jsx(W,{className:"w-[1%] whitespace-nowrap text-right pr-3",children:"Actions"})]}),e.jsxs(O,{children:[e.jsx(j,{children:e.jsxs("div",{className:"relative",children:[e.jsx(G,{value:c,onChange:s=>N(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),u({name:c.trim()||void 0}),x(1))},placeholder:"Filter name…",className:"pl-8 h-8"}),e.jsx(ie,{className:"absolute left-2 top-2 size-4 text-muted-foreground"})]})}),e.jsx(j,{}),e.jsx(j,{className:"text-right pr-3",children:e.jsx(l,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2",disabled:b,onClick:()=>{u({name:c.trim()||void 0}),x(1)},children:"Apply"})})]})]}),e.jsx(Ce,{children:m.slice((w-1)*A,w*A).map(s=>e.jsxs(O,{children:[e.jsx(j,{className:"font-medium",children:s.name}),e.jsx(j,{className:"text-muted-foreground",children:s.parent_group?ae.get(s.parent_group)||s.parent_group:"—"}),e.jsx(j,{className:"text-right pr-3",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(l,{size:"sm",variant:"outline",onClick:()=>E(s.id),children:"View"}),e.jsx(l,{size:"sm",variant:"outline",onClick:()=>{g(s.id),I(s.name),Z(s.parent_group??"")},children:"Edit"}),e.jsx(l,{size:"sm",variant:"destructive",onClick:()=>C(s.id),disabled:B,children:"Delete"})]})})]},s.id))})]})}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No groups found"}),(()=>{const s=Math.max(1,Math.ceil(m.length/A));return!h&&m.length>0?e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(l,{size:"sm",variant:"outline",onClick:()=>x(a=>Math.max(1,a-1)),disabled:w===1,children:"Prev"}),e.jsxs("span",{className:"text-xs",children:["Page ",w," of ",s]}),e.jsx(l,{size:"sm",variant:"outline",onClick:()=>x(a=>Math.min(s,a+1)),disabled:w>=s,children:"Next"})]}):null})()]}),xe&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>y(!1),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[520px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:"New group"}),e.jsx("button",{className:"text-sm text-muted-foreground",onClick:()=>y(!1),children:"Close"})]}),e.jsxs("form",{onSubmit:async s=>{await ge(s)&&y(!1)},className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(T,{htmlFor:"name",children:"Group name"}),e.jsx(G,{id:"name",value:L,onChange:s=>J(s.target.value),placeholder:"Friends"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(T,{htmlFor:"parent",children:"Parent group (optional)"}),e.jsxs("select",{id:"parent",className:"h-9 rounded-md border bg-background px-3 text-sm",value:V,onChange:s=>Q(s.target.value?Number(s.target.value):""),children:[e.jsx("option",{value:"",children:"None"}),m.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),X&&e.jsx("div",{className:"text-sm text-red-600",children:X}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancel"}),e.jsx(l,{type:"submit",disabled:ce,children:"Create"})]})]})]})}),U!==null&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>E(null),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[480px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:"Group details"}),e.jsx("button",{className:"text-sm text-muted-foreground",onClick:()=>E(null),children:"Close"})]}),(()=>{const s=d.find(a=>a.id===U);return s?e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",s.name]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Parent:"})," ",s.parent_group?d.find(a=>a.id===s.parent_group)?.name||s.parent_group:"—"]})]}):e.jsx("div",{className:"text-sm",children:"Not found"})})()]})}),R!==null&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>g(null),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[520px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:"Edit group"}),e.jsx("button",{className:"text-sm text-muted-foreground",onClick:()=>g(null),children:"Close"})]}),e.jsxs("form",{className:"grid gap-3",onSubmit:async s=>{s.preventDefault();try{const a=await oe({id:R,changes:{name:ee.trim(),parent_group:Y===""?null:Y}}).unwrap();z.success(q(a,"Group updated")),g(null)}catch(a){z.error(K(a))}},children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(T,{htmlFor:"edit-g-name",children:"Group name"}),e.jsx(G,{id:"edit-g-name",value:ee,onChange:s=>I(s.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(T,{htmlFor:"edit-parent",children:"Parent group"}),e.jsxs("select",{id:"edit-parent",className:"h-9 rounded-md border bg-background px-3 text-sm",value:Y,onChange:s=>Z(s.target.value?Number(s.target.value):""),children:[e.jsx("option",{value:"",children:"None"}),m.filter(s=>s.id!==R).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>g(null),children:"Cancel"}),e.jsx(l,{type:"submit",disabled:me,children:"Save"})]})]})]})}),M!==null&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>C(null),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[420px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Delete group"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["This action cannot be undone.",(()=>{let s=!1;if(h){const a=(n,$)=>{for(const k of n){if(k.id===$)return k;const te=a(k.children,$);if(te)return te}return null},r=a(ne,M);s=!!r&&r.children.length>0}else s=m.some(a=>a.parent_group===M);return s?" This group has subgroups which may also be affected.":""})()]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>C(null),children:"Cancel"}),e.jsx(l,{variant:"destructive",disabled:B,onClick:async()=>{try{const s=await ue(M).unwrap();z.success(q(s,"Group deleted"))}catch(s){z.error(K(s))}finally{C(null)}},children:"Delete"})]})]})})]})};export{$e as default};
