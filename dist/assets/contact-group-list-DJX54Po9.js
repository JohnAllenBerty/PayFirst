import{r as n,e as je,f as fe,g as Ne,h as ve,j as e,B as r,I as F,L,y as S,i as H,k as K,l as be}from"./index-C7BnS2w6.js";import{S as _}from"./skeleton-wY0_RTiw.js";import{A as re,a as ie,T as ye,b as we,c as U,d as W,e as f,f as Ce}from"./table-DTSNm2yc.js";import{u as ke}from"./useMeta-D07qPjsT.js";import{S as le}from"./search-BVg5HRPL.js";import{F as ze,L as Se,C as _e}from"./layout-list-DHuU-i48.js";function ce({node:i,depth:N,idToName:P,onView:d,onEdit:v,onDelete:A}){const[p,u]=n.useState(!0),b=i.children.length>0,y=i.parent_group?P.get(i.parent_group)||String(i.parent_group):null;return e.jsxs("li",{className:"text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between py-2",style:{paddingLeft:N*12},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[b?e.jsx("button",{type:"button","aria-label":p?"Collapse":"Expand",className:"text-muted-foreground hover:text-foreground transition-colors",onClick:()=>u(h=>!h),children:p?e.jsx(_e,{className:"size-4"}):e.jsx(be,{className:"size-4"})}):e.jsx("span",{className:"inline-block w-4"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium flex items-center gap-2",children:[e.jsx("span",{children:i.name}),b?e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",i.children.length,")"]}):null]}),y&&e.jsxs("div",{className:"text-muted-foreground",children:["Parent: ",y]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{size:"sm",variant:"outline",onClick:()=>d(i.id),children:"View"}),e.jsx(r,{size:"sm",variant:"outline",onClick:()=>v(i.id,i.name,i.parent_group),children:"Edit"}),e.jsx(r,{size:"sm",variant:"destructive",onClick:()=>A(i.id),children:"Delete"})]})]}),b&&p&&e.jsx("ul",{className:"ml-2 border-l pl-3",children:i.children.map(h=>e.jsx(ce,{node:h,depth:N+1,idToName:P,onView:d,onEdit:v,onDelete:A},h.id))})]})}const Te=()=>{const[i,N]=n.useState("name"),{title:P}=ke("/contact/groups","Contact Groups • PayFirst"),[d,v]=n.useState(""),[A,p]=n.useState({}),{data:u,isLoading:b,isFetching:y}=je({ordering:i,search:A.name||void 0}),[h,{isLoading:oe}]=fe(),[de,{isLoading:ue}]=Ne(),[me,{isLoading:Z}]=ve(),[I,q]=n.useState(""),[O,$]=n.useState(""),[J,G]=n.useState(null),[pe,w]=n.useState(!1),[C,x]=n.useState(1),[M,xe]=n.useState(10),[g,X]=n.useState(!0),[Y,E]=n.useState(null),[R,j]=n.useState(null),[ee,V]=n.useState(""),[B,Q]=n.useState(""),[D,k]=n.useState(null),se=u&&!u.status?String(u.error??"Server error"):null,c=n.useMemo(()=>{if(u&&typeof u!="string"){const s=u;if(s.status)return s.data}return[]},[u]),T=n.useMemo(()=>c.some(s=>Array.isArray(s.subgroups)&&s.subgroups.length>0),[c]),he=s=>{const t=[],a=(l,o)=>{t.push({id:l.id,name:l.name,owner:l.owner,parent_group:o}),Array.isArray(l.subgroups)&&l.subgroups.forEach(z=>a(z,l.id))};return s.forEach(l=>a(l,l.parent_group??null)),t},m=n.useMemo(()=>T?he(c):c,[c,T]),te=n.useMemo(()=>{const s=new Map;return m.forEach(t=>s.set(t.id,t.name)),s},[m]),ae=n.useMemo(()=>{if(T){const a=o=>({id:o.id,name:o.name,parent_group:o.parent_group??null,children:Array.isArray(o.subgroups)?o.subgroups.map(a):[]});return c.map(a)}const s=new Map,t=[];for(const a of c)s.set(a.id,{id:a.id,name:a.name,parent_group:a.parent_group??null,children:[]});for(const a of c){const l=s.get(a.id);a.parent_group&&s.has(a.parent_group)?s.get(a.parent_group).children.push(l):t.push(l)}return t},[c,T]),ge=async s=>{if(s.preventDefault(),G(null),!I.trim())return G("Name is required"),!1;try{const t=await h({name:I.trim(),parent_group:O===""?null:O}).unwrap();return q(""),$(""),S.success(H(t,"Group created")),!0}catch(t){return G(K(t)),!1}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h1",{className:"text-xl font-semibold",children:P.replace(/\s*•\s*PayFirst$/,"")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Organize your contacts into groups and subgroups."})]}),se&&e.jsx("div",{className:"max-w-xl rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700",children:se}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{}),e.jsx(r,{size:"sm",onClick:()=>{w(!0),G(null)},children:"New Group"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"font-medium",children:"All groups"}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsxs("div",{className:"relative",children:[e.jsx(F,{value:d,onChange:s=>{v(s.target.value)},onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),p({name:d.trim()||void 0}),x(1))},placeholder:"Filter name…",className:"pl-8 pr-20 h-9 w-56"}),e.jsx(le,{className:"absolute left-2 top-2.5 size-4 text-muted-foreground"}),e.jsxs("div",{className:"absolute inset-y-0 right-0 flex items-center pr-1",children:[e.jsx("span",{className:"h-5 w-px bg-border mr-1","aria-hidden":"true"}),e.jsx(r,{type:"button",variant:"ghost","aria-label":"Apply",title:"Apply",className:"h-9 px-2",disabled:y,onClick:()=>{p({name:d.trim()||void 0}),x(1)},children:"Apply"})]})]}),e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>N(s=>s==="name"?"-name":"name"),className:"gap-1",children:[i.includes("name")&&i.startsWith("-")?e.jsx(re,{className:"size-4"}):e.jsx(ie,{className:"size-4"})," Sort"]}),!g&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-muted-foreground",htmlFor:"group-page-size",children:"Rows per page"}),e.jsxs("select",{id:"group-page-size",className:"h-8 rounded-md border bg-background px-2 text-sm",value:M,onChange:s=>{xe(Number(s.target.value)),x(1)},children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:25,children:"25"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"})]})]}),e.jsxs(r,{variant:g?"default":"outline",size:"sm",className:"gap-1",onClick:()=>X(!0),children:[e.jsx(ze,{className:"size-4"})," Tree"]}),e.jsxs(r,{variant:g?"outline":"default",size:"sm",className:"gap-1",onClick:()=>X(!1),children:[e.jsx(Se,{className:"size-4"})," List"]})]})]}),b?e.jsx("div",{className:"grid gap-2",children:Array.from({length:5}).map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border p-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_,{className:"h-4 w-40"}),e.jsx(_,{className:"h-4 w-24"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-8 w-16"}),e.jsx(_,{className:"h-8 w-16"}),e.jsx(_,{className:"h-8 w-16"})]})]},t))}):m.length?g?e.jsx("ul",{className:"rounded-md border p-2",children:ae.map(s=>e.jsx(ce,{node:s,depth:0,idToName:te,onView:t=>E(t),onEdit:(t,a,l)=>{j(t),V(a),Q(l??"")},onDelete:t=>k(t)},s.id))}):e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsxs(ye,{children:[e.jsxs(we,{children:[e.jsxs(U,{children:[e.jsx(W,{className:"cursor-pointer select-none",onClick:()=>N(s=>s==="name"?"-name":"name"),children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:["Name ",i.includes("name")&&(i.startsWith("-")?e.jsx(re,{className:"size-4"}):e.jsx(ie,{className:"size-4"}))]})}),e.jsx(W,{children:"Parent"}),e.jsx(W,{className:"w-[1%] whitespace-nowrap text-right pr-3",children:"Actions"})]}),e.jsxs(U,{children:[e.jsx(f,{children:e.jsxs("div",{className:"relative",children:[e.jsx(F,{value:d,onChange:s=>v(s.target.value),onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),p({name:d.trim()||void 0}),x(1))},placeholder:"Filter name…",className:"pl-8 h-8"}),e.jsx(le,{className:"absolute left-2 top-2 size-4 text-muted-foreground"})]})}),e.jsx(f,{}),e.jsx(f,{className:"text-right pr-3",children:e.jsx(r,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2",disabled:y,onClick:()=>{p({name:d.trim()||void 0}),x(1)},children:"Apply"})})]})]}),e.jsx(Ce,{children:m.slice((C-1)*M,C*M).map(s=>e.jsxs(U,{children:[e.jsx(f,{className:"font-medium",children:s.name}),e.jsx(f,{className:"text-muted-foreground",children:s.parent_group?te.get(s.parent_group)||s.parent_group:"—"}),e.jsx(f,{className:"text-right pr-3",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(r,{size:"sm",variant:"outline",onClick:()=>E(s.id),children:"View"}),e.jsx(r,{size:"sm",variant:"outline",onClick:()=>{j(s.id),V(s.name),Q(s.parent_group??"")},children:"Edit"}),e.jsx(r,{size:"sm",variant:"destructive",onClick:()=>k(s.id),disabled:Z,children:"Delete"})]})})]},s.id))})]})}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No groups found"}),(()=>{const s=Math.max(1,Math.ceil(m.length/M));return!g&&m.length>0?e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(r,{size:"sm",variant:"outline",onClick:()=>x(t=>Math.max(1,t-1)),disabled:C===1,children:"Prev"}),e.jsxs("span",{className:"text-xs",children:["Page ",C," of ",s]}),e.jsx(r,{size:"sm",variant:"outline",onClick:()=>x(t=>Math.min(s,t+1)),disabled:C>=s,children:"Next"})]}):null})()]}),pe&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>w(!1),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[520px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:"New group"}),e.jsx("button",{className:"text-sm text-muted-foreground",onClick:()=>w(!1),children:"Close"})]}),e.jsxs("form",{onSubmit:async s=>{await ge(s)&&w(!1)},className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{htmlFor:"name",children:"Group name"}),e.jsx(F,{id:"name",value:I,onChange:s=>q(s.target.value),placeholder:"Friends"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{htmlFor:"parent",children:"Parent group (optional)"}),e.jsxs("select",{id:"parent",className:"h-9 rounded-md border bg-background px-3 text-sm",value:O,onChange:s=>$(s.target.value?Number(s.target.value):""),children:[e.jsx("option",{value:"",children:"None"}),m.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),J&&e.jsx("div",{className:"text-sm text-red-600",children:J}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(r,{type:"button",variant:"outline",onClick:()=>w(!1),children:"Cancel"}),e.jsx(r,{type:"submit",disabled:oe,children:"Create"})]})]})]})}),Y!==null&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>E(null),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[480px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:"Group details"}),e.jsx("button",{className:"text-sm text-muted-foreground",onClick:()=>E(null),children:"Close"})]}),(()=>{const s=c.find(t=>t.id===Y);return s?e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",s.name]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Parent:"})," ",s.parent_group?c.find(t=>t.id===s.parent_group)?.name||s.parent_group:"—"]})]}):e.jsx("div",{className:"text-sm",children:"Not found"})})()]})}),R!==null&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>j(null),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[520px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:"Edit group"}),e.jsx("button",{className:"text-sm text-muted-foreground",onClick:()=>j(null),children:"Close"})]}),e.jsxs("form",{className:"grid gap-3",onSubmit:async s=>{s.preventDefault();try{const a=await de({id:R,changes:{name:ee.trim(),parent_group:B===""?null:B}}).unwrap();S.success(H(a,"Group updated")),j(null)}catch(t){S.error(K(t))}},children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{htmlFor:"edit-g-name",children:"Group name"}),e.jsx(F,{id:"edit-g-name",value:ee,onChange:s=>V(s.target.value)})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(L,{htmlFor:"edit-parent",children:"Parent group"}),e.jsxs("select",{id:"edit-parent",className:"h-9 rounded-md border bg-background px-3 text-sm",value:B,onChange:s=>Q(s.target.value?Number(s.target.value):""),children:[e.jsx("option",{value:"",children:"None"}),m.filter(s=>s.id!==R).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsx(r,{type:"button",variant:"outline",onClick:()=>j(null),children:"Cancel"}),e.jsx(r,{type:"submit",disabled:ue,children:"Save"})]})]})]})}),D!==null&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50",onClick:()=>k(null),children:e.jsxs("div",{className:"bg-background rounded-md p-4 w-[420px] max-w-[95vw]",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Delete group"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["This action cannot be undone.",(()=>{let s=!1;if(g){const t=(l,o)=>{for(const z of l){if(z.id===o)return z;const ne=t(z.children,o);if(ne)return ne}return null},a=t(ae,D);s=!!a&&a.children.length>0}else s=m.some(t=>t.parent_group===D);return s?" This group has subgroups which may also be affected.":""})()]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(r,{variant:"outline",onClick:()=>k(null),children:"Cancel"}),e.jsx(r,{variant:"destructive",disabled:Z,onClick:async()=>{try{const s=await me(D).unwrap();S.success(H(s,"Group deleted"))}catch(s){S.error(K(s))}finally{k(null)}},children:"Delete"})]})]})})]})};export{Te as default};
